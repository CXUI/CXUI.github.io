---
layout: post
title:  "Gin 框架添加对 HTTPS 的支持"
date:   2019-10-17 17:10:00

categories: golang
tags: tip
author: "Victor"
---

## 生成证书

首先去 https://keymanager.org 下载并安装客户端。

然后打开 https://freessl.cn/ 注册并登录帐号，点击创建证书会唤醒 KeyManager 弹出验证信息，大概如下图：

![](https://raw.githubusercontent.com/wjp2013/wjp2013.github.io/master/assets/images/pictures/2019-10-17-gin-https/01.png)

参考 [申请证书-域名验证配置指南](https://blog.freessl.cn/free-certificate-verification-guide/)，在 godaddy 的 DNS Management 页面，添加一条 TXT 记录。

大概等待 10 分钟左右，点一下 **配置完成，检测一下** 按钮。验证通过就会成功生成证书。

导出一份 Nginx 服务器平台的证书备用。

## Nginx 配置

### 安装

```bash
yum install epel-release
yum install nginx
systemctl start nginx
systemctl enable nginx
```

### 配置

安装完成之后，在浏览器输入服务器的 IP 可以看到 Nginx 的欢迎页面。它告诉我们需要去 `/etc/nginx/nginx.conf` 进行配置。

* 总配置文件：`/etc/nginx/nginx.conf`
* 常用配置文件目录：`/etc/nginx/conf.d`

新建项目配置文件 `/etc/nginx/conf.d/my_site.conf`

```bash
upstream my_site {
    server localhost:8080;
}

# 将 http 重定向 https
server {
    listen       80;
    server_name domain.com www.domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    # 关键点 通过 443 端口启用 http2 模式
    listen 443 ssl http2 default_server;
    listen [::]:443 ssl http2 default_server;

    server_name domain.com www.domain.com;

    # ssl证书地址
    ssl_certificate /etc/nginx/conf.d/my_site/domain.space_chain.crt;
    ssl_certificate_key /etc/nginx/conf.d/my_site/domain.space_key.key;

    # ssl验证相关配置
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 5m;
    ssl_ciphers EECDH+AES128:HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass_header Server;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://my_site;
    }
}
```

```bash
# 上传证书 HTTPS 证书。
scp /local/domain.space_chain.crt root@IP:/etc/nginx/conf.d/my_site
scp /local/domain.space_key.key root@IP://etc/nginx/conf.d/my_site

# 配置文件是否合法
nginx -t

# 检查并重启 Nginx 服务
nginx -t
service nginx restart
```

别忘了配置防火墙，打开对应的端口。
